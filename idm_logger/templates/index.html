{% extends "base.html" %}

{% block content %}
<div class="row mb-3">
    <div class="col-12 text-end">
        <small id="last-update" class="text-muted">Waiting for data...</small>
    </div>
</div>

<div class="row" id="dashboard-content">
    <div class="col-12 text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<script>
    function formatKey(key) {
        // Humanize keys: "temp_heat_pump_flow" -> "Heat Pump Flow"
        // Remove common prefixes for cleaner display
        let display = key;

        // Remove known prefixes
        const prefixes = ['temp_', 'power_', 'energy_', 'status_', 'mode_', 'state_', 'request_', 'count_', 'valve_state_', 'charge_'];
        for (const p of prefixes) {
            if (display.startsWith(p)) {
                // Keep the prefix meaning but maybe put it in unit or subtitle?
                // Actually users usually want to see "Flow Temp", "Outside Temp".
                // Let's just capitalize and replace underscores.
                break;
            }
        }

        return display.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function getCategory(key) {
        if (key.includes('solar') || key.includes('pv')) return 'Photovoltaics & Solar';
        if (key.includes('circuit') || key.includes('room_') || key.includes('zone_')) return 'Heating Circuits & Zones';
        if (key.includes('storage') || key.includes('water_heater')) return 'Storage & Hot Water';
        if (key.includes('heat_pump') || key.includes('compressor') || key.includes('brine') || key.includes('ground_water') || key.includes('isc')) return 'Heat Pump & Source';
        if (key.includes('energy') || key.includes('power')) return 'Energy & Power';
        if (key.includes('temp_outside')) return 'System';
        return 'Other';
    }

    function getUnit(key) {
        if (key.includes('temp')) return 'Â°C';
        if (key.includes('humidity')) return '%';
        if (key.includes('power')) return 'kW';
        if (key.includes('energy')) return 'kWh';
        if (key.includes('pressure')) return 'bar';
        if (key.includes('percent') || key.includes('load') || key.includes('state_charge')) return '%';
        return '';
    }

    function updateDashboard(data) {
        const container = document.getElementById('dashboard-content');

        // Grouping
        const groups = {
            'System': [],
            'Heat Pump & Source': [],
            'Storage & Hot Water': [],
            'Heating Circuits & Zones': [],
            'Photovoltaics & Solar': [],
            'Energy & Power': [],
            'Other': []
        };

        for (const [key, value] of Object.entries(data)) {
            if (key.endsWith('_str')) continue;

            // Skip binary sensor internal logic if needed, but display is good.

            const cat = getCategory(key);
            if (groups[cat]) {
                groups[cat].push({key, value});
            } else {
                groups['Other'].push({key, value});
            }
        }

        let html = '';
        // Order of display
        const order = ['System', 'Heat Pump & Source', 'Storage & Hot Water', 'Heating Circuits & Zones', 'Photovoltaics & Solar', 'Energy & Power', 'Other'];

        for (const catName of order) {
            const items = groups[catName];
            if (!items || items.length === 0) continue;

            // Sort items by name
            items.sort((a, b) => a.key.localeCompare(b.key));

            html += `<h4 class="mb-3 mt-2 border-bottom pb-2 text-white-50">${catName}</h4>`;
            html += '<div class="row mb-4">';

            items.forEach(item => {
                let displayValue = item.value;
                let unit = getUnit(item.key);

                // Use string representation if available
                if (data[item.key + '_str']) {
                    displayValue = data[item.key + '_str'];
                    unit = ''; // Enums usually don't have units displayed next to text
                } else if (typeof item.value === 'number') {
                     // Rounding
                     displayValue = Math.round(item.value * 100) / 100;
                } else if (typeof item.value === 'boolean') {
                     displayValue = item.value ? 'ON' : 'OFF';
                     unit = '';
                }

                html += `
                    <div class="col-xl-3 col-lg-4 col-md-6 mb-3">
                        <div class="card card-sensor h-100 shadow-sm border-0 bg-dark-subtle">
                            <div class="card-body d-flex flex-column">
                                <div class="text-muted small text-truncate mb-1" title="${item.key}">${formatKey(item.key)}</div>
                                <div class="mt-auto d-flex align-items-baseline">
                                    <span class="sensor-value text-primary me-1">${displayValue}</span>
                                    <span class="sensor-unit">${unit}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
        }

        container.innerHTML = html;
        document.getElementById('last-update').innerText = 'Last updated: ' + new Date().toLocaleTimeString();
    }

    function fetchData() {
        fetch('/api/data')
            .then(response => response.json())
            .then(data => {
                if (Object.keys(data).length > 0) {
                    updateDashboard(data);
                }
            })
            .catch(err => console.error(err));
    }

    setInterval(fetchData, 5000);
    window.onload = fetchData;
</script>
{% endblock %}

services:
  idm-logger:
    build: .
    image: ghcr.io/xerolux/idm-metrics-collector:latest
    container_name: idm-logger
    restart: unless-stopped
    ports:
      - "5008:5000"
    volumes:
      - idm-data:/app/data
    depends_on:
      - victoriametrics
    environment:
      # IDM Heat Pump connection
      - IDM_HOST=192.168.178.103
      - IDM_PORT=502
      # Metrics connection
      - METRICS_URL=http://victoriametrics:8428/write
      # MQTT settings (optional - configure via web UI or uncomment below)
      # - MQTT_ENABLED=false
      # - MQTT_BROKER=mqtt.example.com
      # - MQTT_PORT=1883
      # - MQTT_USERNAME=
      # - MQTT_PASSWORD=
      # - MQTT_USE_TLS=false
      # - MQTT_TOPIC_PREFIX=idm/heatpump
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/api/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  victoriametrics:
    image: victoriametrics/victoria-metrics:latest
    container_name: idm-victoriametrics
    restart: unless-stopped
    ports:
      - "8428:8428"
    volumes:
      - vm-data:/storage
    command:
      - "-storageDataPath=/storage"
      - "-retentionPeriod=1y"

  ml-service:
    # Option 1: Build locally (for development - comment out image below and uncomment build section)
    # build:
    #   context: .
    #   dockerfile: ml_service/Dockerfile
    # Option 2: Use pre-built image from GitHub (for production)
    image: ghcr.io/xerolux/idm-metrics-collector-ml:latest
    container_name: idm-ml-service
    restart: unless-stopped
    depends_on:
      - victoriametrics
      - idm-logger
    volumes:
      - ml-model-data:/app/data
    environment:
      # Core settings
      - METRICS_URL=http://victoriametrics:8428
      - UPDATE_INTERVAL=30
      - MEASUREMENT_NAME=idm_heatpump
      # ML Configuration
      - ANOMALY_THRESHOLD=0.7
      - MIN_DATA_RATIO=0.8
      - MODEL_N_TREES=25
      - MODEL_HEIGHT=15
      - MODEL_WINDOW_SIZE=250
      - MODEL_SAVE_INTERVAL=300
      - MODEL_PATH=/app/data/model_state.pkl
      # Alert settings
      - ENABLE_ALERTS=true
      - ALERT_COOLDOWN=3600
      - IDM_LOGGER_URL=http://idm-logger:5000
      # Sensor coverage (adjust to your setup)
      - ML_CIRCUITS=A
      - ML_ZONES=
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health', timeout=5)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  grafana:
    image: grafana/grafana:latest
    container_name: idm-grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      # Auto-provisioning
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - victoriametrics
    environment:
      # Security
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      # Allow embedding in iframes
      - GF_SECURITY_ALLOW_EMBEDDING=true
      # Anonymous access disabled
      - GF_AUTH_ANONYMOUS_ENABLED=false
      # Default home dashboard
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/var/lib/grafana/dashboards/idm-heatpump.json
      # Plugins
      - GF_INSTALL_PLUGINS=
      # Performance
      - GF_RENDERING_CONCURRENT_RENDER_REQUEST_LIMIT=5
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  vm-data:
    name: idm-vm-data
  grafana-data:
    name: idm-grafana-data
  idm-data:
    name: idm-logger-data
  ml-model-data:
    name: idm-ml-model-data
